# PNG 压缩限制说明

## 为什么 PNG 图片（特别是技术图表）难以大幅压缩？

### 1. PNG 格式特性

- **无损压缩**：PNG 保留所有像素信息，不丢失细节
- **压缩方式**：只能通过减小尺寸来减小文件大小
- **与 JPEG 对比**：JPEG 可以通过降低质量（有损）大幅压缩

## 解决方案

### 方案 1：转换为 JPEG（推荐）

```typescript
// 在配置中选择 JPEG 格式
fileType: "image/jpeg";
quality: 0.85; // 高质量，文字仍清晰
```

**效果预期**：103KB → 30-40KB ✅

**优点**：

- 可以达到 50KB 目标
- 文字仍然清晰可读
- 适合技术文档

**缺点**：

- 轻微质量损失（通常不影响阅读）
- 不支持透明背景

### 方案 2：转换为 WebP（最佳）

```typescript
fileType: "image/webp";
quality: 0.85;
```

**效果预期**：103KB → 25-35KB ✅✅

**优点**：

- 压缩比最高
- 支持透明背景
- 质量损失最小

**缺点**：

- 旧浏览器可能不支持（但现代浏览器都支持）

### 方案 3：大幅缩小尺寸（PNG）

如果必须使用 PNG，只能通过缩小尺寸：

```typescript
// 需要将图片缩小到原来的约 70%
原始尺寸：假设 2000×1500px
目标尺寸：约 1400×1050px

或设置更低的 initialQuality（0.3-0.4）
让系统自动激进缩小尺寸
```

**效果预期**：103KB → 50KB ✅（但图片会变小）

**优点**：

- 保持 PNG 无损特性
- 保持透明背景

**缺点**：

- 图片尺寸明显变小
- 文字可能不够清晰

## 实际操作建议

### 针对你的 103KB 电路图

**选项 A：追求文件大小（推荐）**

1. 格式选择：**WebP** 或 **JPEG**
2. 质量设置：**0.85-0.9**（保证文字清晰）
3. 预期结果：**30-40KB** ✅

**选项 B：必须保持 PNG**

1. 格式选择：**PNG**
2. 设置初始质量：**0.4**（允许激进缩小尺寸）
3. 设置最大尺寸：**1200-1400px**
4. 预期结果：**50-60KB**（勉强接近目标）

**选项 C：接受现实**

1. 保持 PNG 格式
2. 接受压缩到 **60-70KB**
3. 这已经是技术图表的合理压缩比

## PNG 压缩的数学限制

### 为什么 PNG 难以大幅压缩？

```
PNG 文件大小 ≈ (宽 × 高 × 颜色深度 × 复杂度因子) / 压缩效率

技术图表的特点：
- 高分辨率：需要清晰显示文字
- 高对比度：文字+背景，边界清晰
- 复杂内容：线条、符号、文字混合

压缩效率因子：
- 纯色区域：10-20倍压缩
- 渐变区域：3-5倍压缩
- 文字/线条：2-3倍压缩 ⚠️
- 复杂图案：1.5-2倍压缩

你的图片主要是文字/线条，已经接近压缩极限。
```

### 尺寸与文件大小的关系（PNG）

```
假设原图：2000×1500px = 300万像素 → 103KB

压缩到 50KB（约 48.5%）：
需要保留：300万 × 48.5% = 145.5万像素
对应尺寸：约 1400×1050px

计算公式：
新尺寸 = 原尺寸 × √(目标大小/原始大小)
新尺寸 = 2000 × √(50/103)
新尺寸 = 2000 × 0.697
新尺寸 = 1394px

结论：需要将宽度从 2000px 缩小到约 1400px
```

## 当前系统的处理逻辑

我们的压缩系统会：

1. **第一次尝试**：使用 `initialQuality` 和 `maxSizeMB` 压缩
2. **如果未达标**：进行最多 5 次渐进式压缩
3. **每次压缩**：计算 `scaleFactor = √(目标/当前 × 0.7)`
4. **缩小尺寸**：应用 scaleFactor
5. **检查结果**：是否达到目标或无法再压缩

### 为什么可能失败？

```javascript
// 第1次：103KB → 85KB（缩小 17%）
scaleFactor = √(50/103 × 0.7) = √0.34 = 0.58
newSize = 103 × 0.58 = 60KB（尺寸已经很小）

// 第2次：85KB → 70KB
// 继续缩小，但：
// - 尺寸太小，文字开始模糊
// - 压缩效率降低
// - 可能无法达到 50KB
```

**可能的原因**：

- ❌ 图片内容复杂度高，压缩效率低
- ❌ 缩小到某个程度后，PNG 编码开销占比增加
- ❌ 50KB 对于这个复杂度的图片确实太小

## 建议的操作步骤

### 立即尝试（按优先级）：

1. **转换为 WebP 格式**

   - 输出格式选择：WebP
   - 质量：0.85
   - 预期：可达到 50KB 以下 ✅

2. **转换为 JPEG 格式**

   - 输出格式选择：JPEG
   - 质量：0.85
   - 预期：可达到 50KB 以下 ✅

3. **PNG + 极低质量**

   - 输出格式：PNG
   - 初始质量：0.3
   - 预期：50-60KB（接近目标）

4. **接受更大的文件**
   - 目标大小：60-70KB
   - 这是 PNG 的合理压缩比

## 总结

**关键结论**：

- PNG 格式 + 技术图表 = 有限的压缩空间
- 103KB → 50KB（51.5%压缩）对 PNG 太激进
- **建议使用 WebP 或 JPEG** 格式
- 如果必须 PNG，接受 60-70KB 的结果

**记住**：

> 无损压缩（PNG）的本质就是不能丢失信息。
> 要想大幅压缩，要么换有损格式，要么接受小尺寸。
